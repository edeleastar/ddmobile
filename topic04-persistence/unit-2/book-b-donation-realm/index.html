<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.css"
          type="text/css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/railscasts.min.css"
          rel="stylesheet"/>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery.address/1.6/jquery.address.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/kotlin.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <style>
      

body {
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
  font-size:90%;
  color: black;
}

p {
  margin: 0.5em;
}

pre code {
  font-family: "Monaco";
  font-size: 100%;
}

img {
  box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
  margin:10px;
}

h1, h2, h3 {
  border-bottom:thin solid black;
  margin-bottom: 0.5em;
  margin-top: 1em;
}

h1 {
  font-style:italic;
  font-size:130%;
}

h2 {
  font-size:110%;
}

h3 {
  font-size:100%;
}



      

html, body {
  height: 100%;
  margin: 0;
}
.wrapper {
  height: 100%;
  display: flex;
  flex-direction: column;
}
.footer {
  background: white;
  text-align: right;
}
.content {
  flex: 1;
  overflow: auto;
}



    </style>
  </head>

  
  

  <div class="ui fixed top pointing inverted stackable menu labmenu">
    <header class="header item">
      <i id="toc" class="sitemap icon"></i>
      
        <a href="../../index.html"> Data Persistence in Android  </a>
      
    </header>
    <div class="right tab-menu menu">
      
        <a class="item" data-tab="Lab-07">
          Lab-07
        </a>
      
        <a class="item" data-tab="01">
          01
        </a>
      
        <a class="item" data-tab="02">
          02
        </a>
      
        <a class="item" data-tab="03">
          03
        </a>
      
        <a class="item" data-tab="04">
          04
        </a>
      
        <a class="item" data-tab="05">
          05
        </a>
      
        <a class="item" data-tab="06">
          06
        </a>
      
        <a class="item" data-tab="07">
          07
        </a>
      
        <a class="item" data-tab="08">
          08
        </a>
      
        <a class="item" data-tab="09">
          09
        </a>
      
        <a class="item" data-tab="Solution">
          Solution
        </a>
      
    </div>
  </div>


  

  <div class="ui pushable">
    <div class="ui inverted labeled icon left inline vertical sidebar menu">
      <br><br>
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-1-2018//topic01-overview-and-tools/unit-1/book-a-lab-01/index.html">Lab-01 </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-1-2018//topic01-overview-and-tools/unit-1/book-b-lab-02/index.html">Lab-02 </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-1-2018//topic02-activities-and-navigation/unit-1/book-a-donation-02/index.html">Lab-03 </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-1-2018//topic03-app-structure/unit-1/book-a-donation-03/index.html">Lab-04 </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-1-2018//topic04-persistence/unit-1/book-a-donation-03.1/index.html">Lab-05 </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-1-2018//topic04-persistence/unit-2/book-a-donation-04/index.html">Lab-06 </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-1-2018//topic04-persistence/unit-2/book-b-donation-realm/index.html">Lab-07 </a>
          
        
      
    </div>
    <div class="pusher" tabindex="-1">
      <div class="ui basic segment">
        <br>
        
          <div class="ui tab segment lab" data-tab="Lab-07">
            <h1>Objectives</h1>
<p>In <b>Donation.4.0.Realm</b> you will again build on the previous lab and add in some new features and Database Support, and an Application Object. It&#39;s actually very similar to <b>Donation.4.0</b>, but with Realm support, the code base is reduced substantially.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="01">
            <h1>Setup - Starter Code</h1>
<p>As with the previous labs, you can download the solution/starter code for <a href="archives/Donation.4.0.Starter.zip">Donation.4.0.starter</a>, or continue on with your own version.</p>
<p>Your current project (after renaming/copying) should looks something like this:</p>
<p><img src="img/lab5s101.png" alt=""></p>
<p>In this lab, you are required to do the following:</p>
<ul>
<li>Add a new Menu Option - &#39;Reset&#39; - to clear out any donations after the target is reached</li>
<li>Add Realm Database Support to Donation to manage the donations made</li>
<li>Refactor existing Classes to accommodate the new database classes</li>
</ul>
<p>The following steps will guide you through these requirements, so we&#39;ll start with the Menu Option.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="02">
            <h1>Adding a new Menu Option</h1>
<p>First of all, confirm that the current Menu looks like this:</p>
<p><img src="img/lab5s201.png" alt=""></p>
<p>but we want something like this:</p>
<p><img src="img/lab5s202.png" alt=""></p>
<p>The first thing to do is add in a new resource in strings.xml (or use Android Studio (Alt + Return) to fix the string resource error if you paste in the menu item directly)</p>
<pre><code class="lang-xml">     &lt;string name=&quot;menuReset&quot;&gt;Reset&lt;/string&gt;</code></pre>
<p>and then the corresponding menu item in donate.xml</p>
<pre><code class="lang-xml">     &lt;item
        android:id=&quot;@+id/menuReset&quot;
        android:orderInCategory=&quot;100&quot;
        app:showAsAction=&quot;never&quot;
        android:title=&quot;@string/menuReset&quot;
        android:onClick=&quot;reset&quot;/&gt;</code></pre>
<p>It&#39;s probably worth removing the &#39;Settings&#39; menu item at this stage too, and its related method in the Base class. Next, edit <b>Base.java</b> and add in the following method stub</p>
<pre><code class="lang-java">public void reset(MenuItem item) {}</code></pre>
<p>to ensure our app won&#39;t crash when the menu loads (and looks for a method &#39;reset&#39;)</p>
<p>Run the app again and confirm you get the following Menu :</p>
<p><img src="img/lab5s202.png" alt=""></p>
<p>We can&#39;t implement this menu option fully yet, so for the moment, we&#39;ll just &#39;reset&#39; the target amount back to zero (0) - Step 03.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="03">
            <h1>Resetting the Target Amount</h1>
<p>This is more of an interim step but is necessary to ensure the menu event handler for the &#39;Reset&#39; option is working correctly.</p>
<p>First, edit <b>Donate.java</b> and introduce an implementation of the &#39;reset&#39; method</p>
<pre><code class="lang-java"> @Override
  public void reset(MenuItem item)
  {
        // Your implementation goes here
  }</code></pre>
<p>the</p>
<pre><code class="lang-java">@Override</code></pre>
<p>annotation is important - can you explain why?</p>
<p>So add in the code necessary to deal with the Reset Menu option being selected, and reset the <i>totalDonated</i> back to zero (0). You also need to update the Donate UI to reflect this reset, so try and have a go at that too.</p>
<p>Run the app again to confirm that the &#39;Reset&#39; Menu option is now functioning.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="04">
            <h1>Application Object</h1>
<p>Before we complete this step, here&#39;s the code you need for the previous step.</p>
<pre><code class="lang-java"> @Override
  public void reset(MenuItem item)
  {
    totalDonated = 0;
    amountTotal.setText(&quot;$&quot; + totalDonated);
    donations.clear();
  }</code></pre>
<p>In order to keep out application design coherent, we now bring in an &#39;Application&#39; object.</p>
<p>Create a new package called &#39;ie.app.main&#39; and incorporate this class here:</p>
<pre><code class="lang-java">package ie.app.main;

import android.app.Application;
import android.util.Log;

public class DonationApp extends Application
{
  @Override
  public void onCreate()
  {
    super.onCreate();
    Log.v(&quot;Donate&quot;, &quot;Donation App Started&quot;);
  }
}</code></pre>
<p>Application objects need to be references in the AndroidManifest.xml - at the very top as &#39;andorid:name&#39;</p>
<pre><code class="lang-xml">    &lt;application
        android:allowBackup=&quot;true&quot;
        android:icon=&quot;@mipmap/ic_launcher&quot;
        android:label=&quot;@string/app_name&quot;
        android:supportsRtl=&quot;true&quot;
        android:theme=&quot;@style/AppTheme&quot;
        android:name=&quot;ie.app.main.DonationApp&quot;&gt;</code></pre>
<p>Make sure the &#39;Donation App Started&#39; appears in the logs to verify that it has actually been engaged correctly, when you launch the app.</p>
<p><img src="img/lab5s401.png" alt=""></p>

          </div>
        
          <div class="ui tab segment lab" data-tab="05">
            <h1>Donation Model</h1>
<p>We now need to refactor the Base class (next Step) and move the donation related attributes and method (i.e. the variables target, totalDonated and the donations list, and the newDonation() method) into our DonationApp class.</p>
<p>This is a revised version of DonationApp - which now manages a list of donations. It also centralises the &#39;makeDonation&#39; event implementing it as a method. We will also &#39;open&#39; and  &#39;close&#39; our database here eventually. Replace your DonationApp class with this one:</p>
<pre><code class="lang-java">package ie.app.main;

import java.util.ArrayList;
import java.util.List;

import android.app.Application;
import android.util.Log;
import android.widget.Toast;

import ie.app.models.Donation;

public class DonationApp extends Application
{
    public final int       target       = 10000;
    public int             totalDonated = 0;
    public List &lt;Donation&gt; donations    = new ArrayList&lt;Donation&gt;();

    public boolean newDonation(Donation donation)
    {
        boolean targetAchieved = totalDonated &gt; target;
        if (!targetAchieved) {
            donations.add(donation);
            totalDonated += donation.amount;
        }
        else
            Toast.makeText(this, &quot;Target Exceeded!&quot;, Toast.LENGTH_SHORT).show();

        return targetAchieved;
    }

    @Override
    public void onCreate()
    {
        super.onCreate();
        Log.v(&quot;Donate&quot;, &quot;Donation App Started&quot;);
    }
}</code></pre>

          </div>
        
          <div class="ui tab segment lab" data-tab="06">
            <h1>Base Class Refactoring</h1>
<p>The Base activity can now be completely refactored to make use of the DonationApp object. You <b>WILL</b> have errors at the end of this step, due to referencing our (as yet missing) database classes - but we&#39;ll fix those in the next few steps.</p>
<p>This is our new Base class</p>
<pre><code class="lang-java">public class Base extends AppCompatActivity {

    public DonationApp app;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        app = (DonationApp) getApplication();

        app.dbManager.open();
        app.dbManager.setTotalDonated(this);
    }

    @Override
    protected void onDestroy() {
        super.onDestroy();
        app.dbManager.close();
    }

    @Override
    public boolean onCreateOptionsMenu(Menu menu)
    {
        getMenuInflater().inflate(R.menu.menu_donate, menu);
        return true;
    }

    @Override
    public boolean onPrepareOptionsMenu (Menu menu){
        super.onPrepareOptionsMenu(menu);
        MenuItem report = menu.findItem(R.id.menuReport);
        MenuItem donate = menu.findItem(R.id.menuDonate);
        MenuItem reset = menu.findItem(R.id.menuReset);

        if(app.dbManager.getAll().isEmpty())
        {
            report.setEnabled(false);
            reset.setEnabled(false);
        }
        else {
            report.setEnabled(true);
            reset.setEnabled(true);
        }
        if(this instanceof Donate){
            donate.setVisible(false);
            if(!app.dbManager.getAll().isEmpty())
            {
                report.setVisible(true);
                reset.setEnabled(true);
            }
        }
        else {
            report.setVisible(false);
            donate.setVisible(true);
            reset.setVisible(false);
        }
        return true;
    }

    public void report(MenuItem item)
    {
        startActivity (new Intent(this, Report.class));
    }

    public void donate(MenuItem item)
    {
        startActivity (new Intent(this, Donate.class));
    }

    public void reset(MenuItem item) { }
}</code></pre>

          </div>
        
          <div class="ui tab segment lab" data-tab="07">
            <h1>Adding Realm Database Support</h1>
<p>Once you configure the project and add the necessary Database class, (to fix the errors from the previous step) this step is relatively straight forward - all you have to do is replace the method calls that manages the <b><i>donationList</i></b> with the respective <b><i>dbManager</i></b> calls.</p>
<p>First add this to your <b>PROJECT</b> level build.gradle</p>
<pre><code class="lang-XML">classpath &quot;io.realm:realm-gradle-plugin:2.2.1&quot;</code></pre>
<p>under &#39;dependencies&#39; so it looks like</p>
<pre><code class="lang-XML">dependencies {
        classpath &#39;com.android.tools.build:gradle:3.0.1&#39;
        classpath &quot;io.realm:realm-gradle-plugin:2.2.1&quot;

        // NOTE: Do not place your application dependencies here; they belong
        // in the individual module build.gradle files
    }</code></pre>
<p>and add this to your <b>APP</b> level build.gradle</p>
<pre><code class="lang-XML">apply plugin: &#39;realm-android&#39;</code></pre>
<p>at the top of the file so it looks like</p>
<pre><code class="lang-XML">apply plugin: &#39;com.android.application&#39;
apply plugin: &#39;realm-android&#39;</code></pre>
<p>Next thing to do is create is a new <i>ie.app.database</i> package in your project and add the following class to it, and fix any import errors.</p>
<pre><code class="lang-java">public class DBManager {

    public Realm realmDatabase;

    public DBManager(Context context) {
        Realm.init(context);

        RealmConfiguration config = new RealmConfiguration.Builder()
                .name(&quot;donation.realm&quot;)
                .schemaVersion(1)
                .build();

        Realm.setDefaultConfiguration(config);
    }

    public void open() throws SQLException {
        realmDatabase = Realm.getDefaultInstance();
    }

    public void close() {
        realmDatabase.close();
    }

    public void add(Donation d) {
        realmDatabase.beginTransaction();
        realmDatabase.copyToRealm(d);
        realmDatabase.commitTransaction();
    }

    public List&lt;Donation&gt; getAll() {
        RealmResults&lt;Donation&gt; result = realmDatabase.where(Donation.class)
                                                     .findAll();
        return result.subList(0,result.size());
    }

    public Donation get(String id) {
        return realmDatabase.where(Donation.class)
                .equalTo(&quot;id&quot;,id)
                .findAll()
                .first();
    }

    public void setTotalDonated(Base base) {
        base.app.totalDonated = realmDatabase.where(Donation.class)
                                             .findAll()
                                             .sum(&quot;amount&quot;)
                                             .intValue();
    }

    public void reset() {
        realmDatabase.beginTransaction();
        realmDatabase.where(Donation.class)
                     .findAll()
                     .deleteAllFromRealm();
        realmDatabase.commitTransaction();
    }
}</code></pre>
<p>This is our Realm Database Helper Class, which we covered in the lectures, but take a few moments to investigate the class and familiarise yourself with the methods you&#39;ll be using.</p>
<p>There are a few classes you&#39;ll need to modify to add database support to your project so refer to the Lecture Material to complete this.</p>
<p>Next, update your <b>DonationApp</b> class with the following:</p>
<pre><code class="lang-java">public class DonationApp extends Application
{
    public final int       target       = 10000;
    public int             totalDonated = 0;
    public DBManager       dbManager;

    public boolean newDonation(Donation donation)
    {
        boolean targetAchieved = totalDonated &gt; target;
        if (!targetAchieved)
        {
            dbManager.add(donation);
            totalDonated += donation.amount;
        }
        else
        {
            Toast.makeText(this, &quot;Target Exceeded!&quot;, Toast.LENGTH_SHORT).show();
        }
        return targetAchieved;
    }

    @Override
    public void onCreate()
    {
        super.onCreate();
        Log.v(&quot;Donate&quot;, &quot;Donation App Started&quot;);
        dbManager = new DBManager(this);
        dbManager.open();
        Log.v(&quot;Donate&quot;, &quot;Realm Database Created &amp; Opened&quot;);
    }
}</code></pre>
<p><b>Note the references to a new <i>dbManager</i> object.</b></p>
<p>Also, our Donation class needs a slight refactoring, so replace the current class with this one.</p>
<pre><code class="lang-java">public class Donation extends RealmObject
{
    public String id;
    public int    amount;
    public String method;

    public Donation() {}

    public Donation (int amount, String method)
    {
        this.id = UUID.randomUUID().toString();
        this.amount = amount;
        this.method = method;
    }

    @Override
    public String toString() {
        return &quot;Donation{&quot; +
                &quot;id = &quot; + id +
                &quot;amount=$&quot; + amount +
                &quot;, method=&#39;&quot; + method + &#39;\&#39;&#39; +
                &#39;}&#39;;
    }
}</code></pre>
<p>Note the &#39;extends RealmObject&#39;, this is an important part of implementing Realm Database Support so be sure you understand this.</p>
<p>Once you make these changes, commenting out/removing the donations List you&#39;ll get a number of errors, which actually indicates which classes you need to now update and add the database calls (and remove the donations List calls).</p>
<p>Each error requires only one line of code to be fixed, so have a go and updating each of the classes (and we&#39;ll have a look at the solution near the end of the Practical Lab).</p>
<p>Once you fix all the errors, and run the app again, you should still be able to make donations - but this time those donations are stored in our Realm database.</p>
<p>And as a final check, if you shut down the app and restart it again, you should still be able to see the donations made in the Report.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="08">
            <h1>Resetting the Donations</h1>
<p>The last step in this lab involves deleting all the donations in the database when the user wishes to &#39;Reset&#39;.</p>
<p>There&#39;s actually not a lot required in this step - all you need to do is call <b>reset()</b> on your database object when the user selects the Menu option, so modify your reset method (in your Donate.java) as follows:</p>
<pre><code class="lang-java">  @Override
  public void reset(MenuItem item)
  {
      app.dbManager.reset();
        app.totalDonated = 0;
        amountTotal.setText(&quot;$&quot; + app.totalDonated);
  }</code></pre>
<p>You also need to update your <i>onPrepareOptionsMenu()</i> method in your <b>Base</b> class to handle the &#39;Reset&#39; menu option being disabled/displayed properly, so refer to the lecture material for this.</p>
<p>That&#39;s about it really - with one exception. There&#39;s a small bug in the app related to when the app restarts and the target <b>HAS NOT</b> been reached.</p>
<p>Can you find it, and more importantly, fix it?</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="09">
            <h1>Deleting a Donation</h1>
<p>As an extra feature, we&#39;ll take a look at how to possibly delete a single Donation from the database, as opposed to resetting (or deleting ) all the donations, like we did in the last step.</p>
<p>First thing to do is add a new &#39;delete button&#39; to our custom Layout <b>row_donate.xml</b> so it looks like this:</p>
<p><img src="img/lab5s901.png" alt=""></p>
<p>Everything you need is in the screenshot, so pay particular attention to the properties and type of the &#39;button&#39;.</p>
<p>Next, open your <b>Report.java</b> and have a go at &#39;attaching a click event&#39; to the &#39;delete button&#39; on your custom row.</p>
<p>You&#39;ll need to something along the lines of:</p>
<ul>
<li>bind to your new <i>imageDelete</i> widget in your <b>DonationAdapter</b> using &#39;findViewById()&#39;</li>
</ul>
<p>something like</p>
<pre><code class="lang-java">       ImageView deleteView = view.findViewById(R.id.imageDelete);</code></pre>
<ul>
<li>&#39;Tag&#39; the row with the donation id</li>
</ul>
<p>something like</p>
<pre><code class="lang-java">       view.setTag(donation.id);</code></pre>
<ul>
<li>attach an OnClickListener to be triggered on the click of the &#39;button&#39;</li>
</ul>
<p>something like</p>
<pre><code class="lang-java">
       deleteView.setOnClickListener(new View.OnClickListener() {
           @Override
           public void onClick(View v) {
               Toast.makeText(context, &quot;You Want to Delete Donation &quot; +
                       &quot;[ &quot; + app.dbManager.get(view.getTag().toString()) + &quot;]&quot;,Toast.LENGTH_LONG).show();

           }
       });</code></pre>
<p>if all goes to plan you should get something OnClickListener</p>
<p><img src="img/lab5s902.png" alt=""></p>
<p>Where&#39;s the actual deleting you may ask? Well, that&#39;ll be up to you....</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="Solution">
            <h1>Solution</h1>
<p>This is a solution to the lab:</p>
<ul>
<li><a href="archives/Donation.4.0.Realm.zip">Donation.4.0.Realm</a></li>
</ul>

          </div>
        
      </div>
    </div>
  </div>


  <br>
  <script>
    $(document).on('keydown', function(e) {
  e = e || window.event;
  var nextTab;
  switch (e.which || e.keyCode) {
    case 37: // left
      nextTab = $('.tab-menu a[data-tab].active').prev('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').last();
      nextTab.click();
      $('.pusher').focus();
      break;

    case 39: // right
      nextTab = $('.tab-menu a[data-tab].active').next('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').first();
      nextTab.click();
      $('.pusher').focus();
      break;
  }
});

    $(document).ready(function() {
  $('img').addClass('ui image');

  $('.ui.embed').embed();

  const $images = $('.lab img');
  jQuery.each($images, function(i) {
    if ($images[i].alt.length > 0) {
      const divImg = $(document.createElement('div')).addClass(
        'ui basic segment',
      );
      $($images[i]).wrap(divImg);
      const divLabel = $(document.createElement('div')).addClass(
        'ui blue ribbon label',
      );
      divLabel.append($images[i].alt);
      $(divLabel).insertBefore($images[i]);
    }
  });

  $('.ui.menu .item').tab({
    history: true,
    historyType: 'hash',
  });

  $('.popup').popup();

  $('.ui.sidebar')
    .sidebar({ context: $('.pushable') })
    .sidebar('setting', 'transition', 'slide out')
    .sidebar('attach events', '#toc');
});

  </script>



  <div class="ui bottom fixed borderless right menu">
    <div class="ui right small menu">
      <div class="ui tiny basic message segment">
         Powered by <a href="https://github.com/edeleastar/tutors-ts">tutors-ts.</a> 
      </div>
    </div>
  </div>

  </body>

</html>